<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
<meta name="viewport" content="width=device-width">
<meta name="theme-color" content="#222"><meta name="generator" content="Hexo 6.3.0">

  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png">
  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png">
  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png">
  <link rel="mask-icon" href="/images/logo.svg" color="#222">

<link rel="stylesheet" href="/css/main.css">



<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" integrity="sha256-HtsXJanqjKTc8vVQjO4YMhiqFoXkfBsjBWcX91T1jr8=" crossorigin="anonymous">

<script class="next-config" data-name="main" type="application/json">{"hostname":"celeo.github.io","root":"/","images":"/images","scheme":"Muse","darkmode":false,"version":"8.16.0","exturl":false,"sidebar":{"position":"left","display":"post","padding":18,"offset":12},"copycode":{"enable":false,"style":null},"bookmark":{"enable":false,"color":"#222","save":"auto"},"mediumzoom":false,"lazyload":false,"pangu":false,"comments":{"style":"tabs","active":null,"storage":true,"lazyload":false,"nav":null},"stickytabs":false,"motion":{"enable":false,"async":false,"transition":{"menu_item":"fadeInDown","post_block":"fadeIn","post_header":"fadeInDown","post_body":"fadeInDown","coll_header":"fadeInLeft","sidebar":"fadeInUp"}},"prism":false,"i18n":{"placeholder":"Searching...","empty":"We didn't find any results for the search: ${query}","hits_time":"${hits} results found in ${time} ms","hits":"${hits} results found"}}</script><script src="/js/config.js"></script>

    <meta name="description" content="Better than Paramiko for what I needed.">
<meta property="og:type" content="article">
<meta property="og:title" content="Useful Python libraries 4 - Fabric">
<meta property="og:url" content="https://celeo.github.io/2016/01/01/useful-python-libraries-4-fabric/index.html">
<meta property="og:site_name" content="Etchings">
<meta property="og:description" content="Better than Paramiko for what I needed.">
<meta property="og:locale" content="en_US">
<meta property="article:published_time" content="2016-01-01T08:00:00.000Z">
<meta property="article:modified_time" content="2024-04-30T02:23:45.344Z">
<meta property="article:author" content="Matt Boulanger">
<meta property="article:tag" content="programming">
<meta property="article:tag" content="old_blog">
<meta name="twitter:card" content="summary">


<link rel="canonical" href="https://celeo.github.io/2016/01/01/useful-python-libraries-4-fabric/">



<script class="next-config" data-name="page" type="application/json">{"sidebar":"","isHome":false,"isPost":true,"lang":"en","comments":true,"permalink":"https://celeo.github.io/2016/01/01/useful-python-libraries-4-fabric/","path":"2016/01/01/useful-python-libraries-4-fabric/","title":"Useful Python libraries 4 - Fabric"}</script>

<script class="next-config" data-name="calendar" type="application/json">""</script>
<title>Useful Python libraries 4 - Fabric | Etchings</title>
  








  <noscript>
    <link rel="stylesheet" href="/css/noscript.css">
  </noscript>
</head>

<body itemscope itemtype="http://schema.org/WebPage">
  <div class="headband"></div>

  <main class="main">
    <div class="column">
      <header class="header" itemscope itemtype="http://schema.org/WPHeader"><div class="site-brand-container">
  <div class="site-nav-toggle">
    <div class="toggle" aria-label="Toggle navigation bar" role="button">
        <span class="toggle-line"></span>
        <span class="toggle-line"></span>
        <span class="toggle-line"></span>
    </div>
  </div>

  <div class="site-meta">

    <a href="/" class="brand" rel="start">
      <i class="logo-line"></i>
      <p class="site-title">Etchings</p>
      <i class="logo-line"></i>
    </a>
  </div>

  <div class="site-nav-right">
    <div class="toggle popup-trigger" aria-label="Search" role="button">
    </div>
  </div>
</div>



<nav class="site-nav">
  <ul class="main-menu menu"><li class="menu-item menu-item-home"><a href="/" rel="section"><i class="fa fa-home fa-fw"></i>Home</a></li><li class="menu-item menu-item-tags"><a href="/tags/" rel="section"><i class="fa fa-tags fa-fw"></i>Tags</a></li><li class="menu-item menu-item-archives"><a href="/archives/" rel="section"><i class="fa fa-archive fa-fw"></i>Archives</a></li><li class="menu-item menu-item-github"><a href="https://github.com/Celeo" rel="section" target="_blank"><i class="fa fa-link fa-fw"></i>GitHub</a></li>
  </ul>
</nav>




</header>
        
  
  <aside class="sidebar">

    <div class="sidebar-inner sidebar-nav-active sidebar-toc-active">
      <ul class="sidebar-nav">
        <li class="sidebar-nav-toc">
          Table of Contents
        </li>
        <li class="sidebar-nav-overview">
          Overview
        </li>
      </ul>

      <div class="sidebar-panel-container">
        <!--noindex-->
        <div class="post-toc-wrap sidebar-panel">
            <div class="post-toc animated"><ol class="nav"><li class="nav-item nav-level-2"><a class="nav-link" href="#Installation"><span class="nav-number">1.</span> <span class="nav-text">Installation</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Making-the-connection"><span class="nav-number">2.</span> <span class="nav-text">Making the connection</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Running-commands"><span class="nav-number">3.</span> <span class="nav-text">Running commands</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#SCP"><span class="nav-number">4.</span> <span class="nav-text">SCP</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Review"><span class="nav-number">5.</span> <span class="nav-text">Review</span></a></li></ol></div>
        </div>
        <!--/noindex-->

        <div class="site-overview-wrap sidebar-panel">
          <div class="site-author animated" itemprop="author" itemscope itemtype="http://schema.org/Person">
  <p class="site-author-name" itemprop="name">Matt Boulanger</p>
  <div class="site-description" itemprop="description">Personal blog</div>
</div>
<div class="site-state-wrap animated">
  <nav class="site-state">
      <div class="site-state-item site-state-posts">
        <a href="/archives/">
          <span class="site-state-item-count">82</span>
          <span class="site-state-item-name">posts</span>
        </a>
      </div>
      <div class="site-state-item site-state-tags">
          <a href="/tags/">
        <span class="site-state-item-count">18</span>
        <span class="site-state-item-name">tags</span></a>
      </div>
  </nav>
</div>

        </div>
      </div>
    </div>

    
  </aside>


    </div>

    <div class="main-inner post posts-expand">


  


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="en">
    <link itemprop="mainEntityOfPage" href="https://celeo.github.io/2016/01/01/useful-python-libraries-4-fabric/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="Matt Boulanger">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Etchings">
      <meta itemprop="description" content="Personal blog">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="Useful Python libraries 4 - Fabric | Etchings">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h1 class="post-title" itemprop="name headline">
          Useful Python libraries 4 - Fabric
        </h1>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">Posted on</span>

      <time title="Created: 2016-01-01 00:00:00" itemprop="dateCreated datePublished" datetime="2016-01-01T00:00:00-08:00">2016-01-01</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar-check"></i>
      </span>
      <span class="post-meta-item-text">Edited on</span>
      <time title="Modified: 2024-04-29 19:23:45" itemprop="dateModified" datetime="2024-04-29T19:23:45-07:00">2024-04-29</time>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody"><p>Better than Paramiko for what I needed.</p>
<span id="more"></span>

<blockquote>
<p>&quot;Fabric is a Python (2.5-2.7) library and command-line tool for streamlining the use of SSH for application deployment or systems administration tasks.&quot;</p>
</blockquote>
<ul>
<li><a target="_blank" rel="noopener" href="https://github.com/fabric/fabric">GitHub link</a></li>
<li><a target="_blank" rel="noopener" href="https://pypi.python.org/pypi/Fabric">PyPi link</a></li>
<li><a target="_blank" rel="noopener" href="http://www.fabfile.org/">Homepage</a></li>
<li><a target="_blank" rel="noopener" href="http://docs.fabfile.org/en/1.11/">Docs</a></li>
</ul>
<p>A while back, I wrote about using Paramiko to control several devices through SSH and SCP. Unfortunately, the code I used had some shortcomings, most notably I had no way to determine if a command had finished. I was using some low-level communication methods to persist a login to the root user account.</p>
<p>There&#39;s a better way to do that, and it&#39;s with Fabric.</p>
<h2 id="Installation"><a href="#Installation" class="headerlink" title="Installation"></a>Installation</h2><p>First off, installation (as the homepage notes, Fabric runs on 2.5-2.7, not 3.X):</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ pip install fabric</span><br></pre></td></tr></table></figure>

<p>You may need a supporting library in order to install PyCrypto. For Debian (specifically, Linux Mint 17.2) I needed python-dev:</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">$ sudo apt-get update</span><br><span class="line">$ sudo apt-get install python-dev</span><br></pre></td></tr></table></figure>

<h2 id="Making-the-connection"><a href="#Making-the-connection" class="headerlink" title="Making the connection"></a>Making the connection</h2><p>Fabric is much more than a simple tool to execute SSH commands to a target, but that&#39;s what I needed it for, so that&#39;s what we&#39;ll take a look at.</p>
<p>First, imports:</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">from fabric.api import env, run as _run, sudo as _sudo</span><br><span class="line">from fabric.tasks import execute</span><br><span class="line">from fabric.network import disconnect_all</span><br><span class="line">from fabric.state import connections</span><br><span class="line">I imported the run and sudo methods as _run and _sudo, respectively, because I&#x27;m going to wrap them to give them some default parameters.</span><br><span class="line"></span><br><span class="line">def run(command, **kwargs):</span><br><span class="line">    kwargs[&#x27;quiet&#x27;] = kwargs.get(&#x27;quiet&#x27;, True)</span><br><span class="line">    kwargs[&#x27;combine_stderr&#x27;] = kwargs.get(&#x27;combine_stderr&#x27;, False)</span><br><span class="line">    kwargs[&#x27;pty&#x27;] = kwargs.get(&#x27;pty&#x27;, False)</span><br><span class="line">    return _run(command, **kwargs)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">def sudo(command, **kwargs):</span><br><span class="line">    kwargs[&#x27;quiet&#x27;] = kwargs.get(&#x27;quiet&#x27;, True)</span><br><span class="line">    kwargs[&#x27;combine_stderr&#x27;] = kwargs.get(&#x27;combine_stderr&#x27;, False)</span><br><span class="line">    return _sudo(command, **kwargs)</span><br></pre></td></tr></table></figure>

<p>I&#39;ve found this combination of arguments to the run and sudo methods to produce the cleanest output on the systems that I&#39;m testing it on. With these wrappers, I can call run(&#39;df -h&#39;) without having to pass the other arguments that I usually want, though, if I wanted to, I could overwrite any of them.</p>
<p>Next, configuration.</p>
<p>Fabric uses an &quot;environment dictionary&quot; called <code>env</code> to hold the configuration, which we imported from <code>fabric.api</code> above. We need to add a few things to the <code>env</code> variable:</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">env.hosts = [&#x27;10.10.7.100&#x27;, &#x27;10.10.7.101&#x27;, &#x27;10.10.7.102&#x27;]</span><br><span class="line">env.user = &#x27;admin&#x27;</span><br><span class="line">env.key_filename = &#x27;id_rsa&#x27;</span><br><span class="line">For this example, I&#x27;m using key-based authentication for 3 target systems. The SSH login uses the username &#x27;admin&#x27;. That&#x27;s it for configuration! When we call our method to actually go and perform actions on the target systems, Fabric will perform all the instructions for the first system at 10.10.7.100, then the next at 10.10.7.101, and so on.</span><br></pre></td></tr></table></figure>

<h2 id="Running-commands"><a href="#Running-commands" class="headerlink" title="Running commands"></a>Running commands</h2><p>The syntax for executing commands is extremely simple since we&#39;ve wrapped those methods with our default arguments:</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">run(&#x27;command&#x27;)</span><br><span class="line">sudo(&#x27;root command&#x27;)</span><br><span class="line">sudo(&#x27;command as other user&#x27;, user=&#x27;otheruser&#x27;)</span><br></pre></td></tr></table></figure>

<p>That&#39;s it. When we first run a superuser command, assuming that the user we&#39;re logged into, &#39;admin&#39;, requires a password, Fabric will prompt the user to enter the password from the command line (and it&#39;ll hide it as the user types, just like entering the password locally).</p>
<p>What about running commands locally? We could import <code>subprocess</code> and execute from there, but Fabric has a wrapper for us to use:</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">local(&#x27;command&#x27;, capture=False, shell=None)</span><br></pre></td></tr></table></figure>

<p>You should normally be fine omitting shell, as it defaults to &#39;&#x2F;bin&#x2F;sh&#39;, unless you need bash. I set capture to True, as I&#39;d like to capture the output from the command and display it if needed instead of it immediately being written to the console, potentially adding clutter.</p>
<h2 id="SCP"><a href="#SCP" class="headerlink" title="SCP"></a>SCP</h2><p>Fabric uses Paramiko, which means that we can too! Remember this from the Paramiko post?</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">import scp</span><br><span class="line">with scp.SCPClient(ssh.get_transport()) as _scp:</span><br><span class="line">    _scp.get(&#x27;/path/to/filename&#x27;)</span><br></pre></td></tr></table></figure>

<p>With a few modifications, we can still use this module to perform our SCP gets and puts:</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">with support_scp.SCPClient(connections[&#x27;%s@%s:22&#x27; % (env.user, env.host_string)].get_transport()) as _scp:</span><br><span class="line">        _scp.get(&#x27;/path/to/filename&#x27;)</span><br></pre></td></tr></table></figure>

<p>Here, we don&#39;t have access to a <code>SSHClient</code> from Paramiko directly, so we use Fabric&#39;s connections variable to access those lower-level variables. connections is (effectively) a dictionary, so we can access the connection variables with the currently-targeted IP address as the key, which we get from <code>env.host_string</code>.</p>
<p>Fabric has built-in methods to get and put files through the existing connection, but the transport method is SFTP. I needed SCP, so I used this module. If you can work with SFTP, then here&#39;s the link to the documentation for those methods.</p>
<h2 id="Review"><a href="#Review" class="headerlink" title="Review"></a>Review</h2><p>It seems like I didn&#39;t look hard enough when I went searching for an SSH library to control devices in Python originally. Since Fabric uses Paramiko, it wasn&#39;t a loss, though. I was able to apply what I learned with Paramiko to Fabric, as I couldn&#39;t use Fabric&#39;s SFTP protocol to move files - I had to go down a level and use Paramiko with the SCP library I found previously.</p>
<p>Regardless of how I got here, Fabric is definitely the better tool for this job.</p>

    </div>

    
    
    

    <footer class="post-footer">
          <div class="post-tags">
              <a href="/tags/programming/" rel="tag"># programming</a>
              <a href="/tags/old-blog/" rel="tag"># old_blog</a>
          </div>

        

          <div class="post-nav">
            <div class="post-nav-item">
                <a href="/2016/01/01/useful-python-libraries-5-selenium/" rel="prev" title="Useful Python libraries 5 - Selenium">
                  <i class="fa fa-chevron-left"></i> Useful Python libraries 5 - Selenium
                </a>
            </div>
            <div class="post-nav-item">
                <a href="/2016/01/01/useful-python-libraries-3-requests/" rel="next" title="Useful Python libraries 3 - Requests">
                  Useful Python libraries 3 - Requests <i class="fa fa-chevron-right"></i>
                </a>
            </div>
          </div>
    </footer>
  </article>
</div>






</div>
  </main>

  <footer class="footer">
    <div class="footer-inner">


<div class="copyright">
  &copy; 
  <span itemprop="copyrightYear">2025</span>
  <span class="with-love">
    <i class="fa fa-heart"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">Matt Boulanger</span>
</div>
  <div class="powered-by">Powered by <a href="https://hexo.io/" rel="noopener" target="_blank">Hexo</a> & <a href="https://theme-next.js.org/muse/" rel="noopener" target="_blank">NexT.Muse</a>
  </div>

    </div>
  </footer>

  
  <div class="toggle sidebar-toggle" role="button">
    <span class="toggle-line"></span>
    <span class="toggle-line"></span>
    <span class="toggle-line"></span>
  </div>
  <div class="sidebar-dimmer"></div>
  <div class="back-to-top" role="button" aria-label="Back to top">
    <i class="fa fa-arrow-up fa-lg"></i>
    <span>0%</span>
  </div>

<noscript>
  <div class="noscript-warning">Theme NexT works best with JavaScript enabled</div>
</noscript>


  
  <script src="https://cdnjs.cloudflare.com/ajax/libs/animejs/3.2.1/anime.min.js" integrity="sha256-XL2inqUJaslATFnHdJOi9GfQ60on8Wx1C2H8DYiN1xY=" crossorigin="anonymous"></script>
<script src="/js/comments.js"></script><script src="/js/utils.js"></script><script src="/js/schemes/muse.js"></script><script src="/js/next-boot.js"></script>

  





  





</body>
</html>
